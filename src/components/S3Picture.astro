---
/**
 * S3Picture Component
 * 
 * Responsive image component using <picture> element with multiple sources.
 * Automatically resolves S3 URLs using the mapping system.
 * 
 * @example
 * <S3Picture 
 *   identifier="s3-file://uploads/photo.jpg"
 *   alt="My Photo"
 *   sizes="(max-width: 768px) 100vw, 50vw"
 * />
 */

interface Source {
  /** S3 identifier or key for this source */
  identifier?: string;
  s3Key?: string;
  /** Media query for this source */
  media?: string;
  /** Image type (e.g., 'image/webp', 'image/jpeg') */
  type?: string;
}

interface Props {
  /** Primary S3 file identifier (fallback image) */
  identifier?: string;
  /** Direct S3 key (will be converted to identifier) */
  s3Key?: string;
  /** Alternative sources for responsive images */
  sources?: Source[];
  /** Alt text for the image */
  alt: string;
  /** Optional CSS class */
  class?: string;
  /** Optional width */
  width?: number | string;
  /** Optional height */
  height?: number | string;
  /** Loading strategy */
  loading?: 'lazy' | 'eager';
  /** Object fit */
  fit?: 'cover' | 'contain' | 'fill' | 'none' | 'scale-down';
}

const { 
  identifier, 
  s3Key, 
  sources = [],
  alt, 
  class: className = '', 
  width, 
  height,
  loading = 'lazy',
  fit = 'cover'
} = Astro.props;

// Validate that either identifier or s3Key is provided
if (!identifier && !s3Key) {
  throw new Error('S3Picture: Either "identifier" or "s3Key" prop is required');
}

// Helper function to resolve URL
async function resolveUrl(fileIdentifier: string) {
  try {
    const response = await fetch(`${Astro.url.origin}/api/s3`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        action: 'resolveUrl', 
        identifier: fileIdentifier 
      }),
    });

    if (!response.ok) {
      throw new Error(`Failed to resolve URL: ${response.statusText}`);
    }

    const data = await response.json();
    return data.url;
  } catch (err) {
    console.error('S3Picture: Failed to resolve URL', { identifier: fileIdentifier, error: err });
    return null;
  }
}

// Resolve all source URLs
const resolvedSources = await Promise.all(
  sources.map(async (source) => {
    const sourceIdentifier = source.identifier || `s3-file://${source.s3Key}`;
    const url = await resolveUrl(sourceIdentifier);
    return {
      url,
      media: source.media,
      type: source.type,
    };
  })
);

// Resolve primary image URL
const fileIdentifier = identifier || `s3-file://${s3Key}`;
const imageUrl = await resolveUrl(fileIdentifier);

// Build style object
const styles = [];
if (width) styles.push(`width: ${typeof width === 'number' ? `${width}px` : width}`);
if (height) styles.push(`height: ${typeof height === 'number' ? `${height}px` : height}`);
if (fit) styles.push(`object-fit: ${fit}`);
const styleAttr = styles.length > 0 ? styles.join('; ') : undefined;
---

{imageUrl ? (
  <picture class={className}>
    {resolvedSources.map(source => source.url && (
      <source 
        srcset={source.url}
        media={source.media}
        type={source.type}
      />
    ))}
    <img 
      src={imageUrl} 
      alt={alt}
      width={width}
      height={height}
      loading={loading}
      style={styleAttr}
      data-s3-identifier={fileIdentifier}
    />
  </picture>
) : (
  <div 
    class:list={['s3-picture-error', className]} 
    role="img" 
    aria-label={alt}
    style={styleAttr}
  >
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    <span>Failed to load image</span>
  </div>
)}

<style>
  .s3-picture-error {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: #f8f9fa;
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 2rem;
    color: #6c757d;
    min-width: 200px;
    min-height: 200px;
  }

  .s3-picture-error svg {
    width: 48px;
    height: 48px;
    margin-bottom: 0.5rem;
    opacity: 0.5;
  }

  .s3-picture-error span {
    font-size: 0.875rem;
    font-weight: 500;
  }
</style>
