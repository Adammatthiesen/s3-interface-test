---
import { s3ApiService } from '../lib/s3-api';

/**
 * S3Image Component
 * 
 * Displays an image from S3 storage using the URL mapping system.
 * Supports both s3-file:// identifiers and direct S3 keys.
 * 
 * @example
 * <S3Image identifier="s3-file://uploads/photo.jpg" alt="My Photo" />
 * <S3Image s3Key="uploads/photo.jpg" alt="My Photo" class="rounded" />
 */

interface Props {
  /** S3 file identifier (e.g., "s3-file://path/to/image.jpg") */
  identifier?: string;
  /** Direct S3 key (will be converted to identifier) */
  s3Key?: string;
  /** Alt text for the image */
  alt: string;
  /** Optional CSS class */
  class?: string;
  /** Optional width */
  width?: number | string;
  /** Optional height */
  height?: number | string;
  /** Loading strategy */
  loading?: 'lazy' | 'eager';
  /** Object fit */
  fit?: 'cover' | 'contain' | 'fill' | 'none' | 'scale-down';
}

const { 
  identifier, 
  s3Key, 
  alt, 
  class: className = '', 
  width, 
  height,
  loading = 'lazy',
  fit = 'cover'
} = Astro.props;

// Validate that either identifier or s3Key is provided
if (!identifier && !s3Key) {
  throw new Error('S3Image: Either "identifier" or "s3Key" prop is required');
}

// Create identifier from s3Key if needed
const fileIdentifier = identifier || `s3-file://${s3Key}`;

// Fetch URL from the mapping service
let imageUrl = '';
let isPermanent = false;
let error = '';

try {
  const data = await s3ApiService.resolveUrl(fileIdentifier);
  imageUrl = data.url;
  isPermanent = data.isPermanent;
} catch (err) {
  error = err instanceof Error ? err.message : 'Unknown error';
  console.error('S3Image: Failed to load image URL', { identifier: fileIdentifier, error });
}

// Build style object
const styles = [];
if (width) styles.push(`width: ${typeof width === 'number' ? `${width}px` : width}`);
if (height) styles.push(`height: ${typeof height === 'number' ? `${height}px` : height}`);
if (fit) styles.push(`object-fit: ${fit}`);
const styleAttr = styles.length > 0 ? styles.join('; ') : undefined;
---

{error ? (
  <div 
    class:list={['s3-image-error', className]} 
    role="img" 
    aria-label={alt}
    data-error={error}
    style={styleAttr}
  >
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    <span>Failed to load image</span>
  </div>
) : (
  <img 
    src={imageUrl} 
    alt={alt}
    class={className}
    width={width}
    height={height}
    loading={loading}
    style={styleAttr}
    data-s3-identifier={fileIdentifier}
    data-permanent={isPermanent}
  />
)}

<style>
  .s3-image-error {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: #f8f9fa;
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 2rem;
    color: #6c757d;
    min-width: 200px;
    min-height: 200px;
  }

  .s3-image-error svg {
    width: 48px;
    height: 48px;
    margin-bottom: 0.5rem;
    opacity: 0.5;
  }

  .s3-image-error span {
    font-size: 0.875rem;
    font-weight: 500;
  }
</style>
