---
/**
 * StorageImage Component
 * 
 * Displays an image from cloud storage using the URL mapping system.
 * Supports both storage-file:// identifiers and direct storage keys.
 * 
 * @example
 * <StorageImage identifier="storage-file://uploads/photo.jpg" alt="My Photo" />
 * <StorageImage storageKey="uploads/photo.jpg" alt="My Photo" class="rounded" />
 */

interface Props {
  /** Storage file identifier (e.g., "storage-file://path/to/image.jpg") */
  identifier?: `storage-file://${string}`;
  /** Direct storage key (will be converted to identifier) */
  storageKey?: string;
  /** Alt text for the image */
  alt: string;
  /** Optional CSS class */
  class?: string;
  /** Optional width */
  width?: number | string;
  /** Optional height */
  height?: number | string;
  /** Loading strategy */
  loading?: 'lazy' | 'eager';
  /** Object fit */
  fit?: 'cover' | 'contain' | 'fill' | 'none' | 'scale-down';
  /** API endpoint for S3 operations */
  apiEndpoint?: string;
}

const { 
  identifier, 
  storageKey, 
  alt, 
  class: className = '', 
  width, 
  height,
  loading = 'lazy',
  fit = 'cover',
  apiEndpoint = '/api/storage'
} = Astro.props;

// Validate that either identifier or storageKey is provided
if (!identifier && !storageKey) {
  throw new Error('StorageImage: Either "identifier" or "storageKey" prop is required');
}

// Create identifier from storageKey if needed
const fileIdentifier = identifier || `storage-file://${storageKey}`;

// Fetch URL from the API endpoint
let imageUrl = '';
let isPermanent = false;
let error = '';

try {
  const response = await fetch(new URL(apiEndpoint, Astro.request.url), {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ action: 'resolveUrl', identifier: fileIdentifier }),
  });
  
  if (!response.ok) {
    throw new Error(`Failed to resolve URL: ${response.statusText}`);
  }
  
  const data = await response.json();
  imageUrl = data.url;
  isPermanent = data.isPermanent;
} catch (err) {
  error = err instanceof Error ? err.message : 'Unknown error';
  console.error('StorageImage: Failed to load image URL', { identifier: fileIdentifier, error });
}

// Build style object
const styles = [];
if (width) styles.push(`width: ${typeof width === 'number' ? `${width}px` : width}`);
if (height) styles.push(`height: ${typeof height === 'number' ? `${height}px` : height}`);
if (fit) styles.push(`object-fit: ${fit}`);
const styleAttr = styles.length > 0 ? styles.join('; ') : undefined;
---

{error ? (
  <div 
    class:list={['s3-image-error', className]} 
    role="img" 
    aria-label={alt}
    data-error={error}
    style={styleAttr}
  >
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    <span>Failed to load image</span>
  </div>
) : (
  <img 
    src={imageUrl} 
    alt={alt}
    class={className}
    width={width}
    height={height}
    loading={loading}
    style={styleAttr}
    data-s3-identifier={fileIdentifier}
    data-permanent={isPermanent}
  />
)}

<style>
  .s3-image-error {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: #f8f9fa;
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 2rem;
    color: #6c757d;
    min-width: 200px;
    min-height: 200px;
  }

  .s3-image-error svg {
    width: 48px;
    height: 48px;
    margin-bottom: 0.5rem;
    opacity: 0.5;
  }

  .s3-image-error span {
    font-size: 0.875rem;
    font-weight: 500;
  }
</style>
